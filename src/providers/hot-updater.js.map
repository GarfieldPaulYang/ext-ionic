{"version":3,"sources":["hot-updater.ts"],"names":[],"mappings":"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","file":"hot-updater.js","sourceRoot":"","sourcesContent":["import { Injectable } from '@angular/core';\nimport { Platform } from 'ionic-angular';\nimport { Transfer } from '@ionic-native/transfer';\nimport { File } from '@ionic-native/file';\nimport { FileOpener } from '@ionic-native/file-opener';\n\nimport { HotCodePush } from '../native/hot-code-push';\nimport { ConfigProvider } from '../config/config';\nimport { Dialog } from '../utils/dialog';\nimport { ExtLocalNotifications } from '../native/local-notifications';\n\n\nexport class HotUpdater {\n  constructor(\n    private platform: Platform,\n    private dialog: Dialog,\n    private config: ConfigProvider,\n    private hotCodePush: HotCodePush,\n    private localNotifications: ExtLocalNotifications,\n    private transfer: Transfer,\n    private file: File,\n    private fileOpener: FileOpener\n  ) { }\n\n  start() {\n    this.hotCodePush.isUpdateAvailableForInstallation((error, data) => {\n      if (!error) {\n        this.hotCodePush.installUpdate().then(error => {\n          console.log(error);\n        });\n        return;\n      }\n      this.hotCodePush.fetchUpdate((error, data) => {\n        if (!error) {\n          this.dialog.confirm('更新通知', '新版本更新成功,是否现在重启应用?', () => {\n            this.hotCodePush.installUpdate().then(e => {\n              console.log(e);\n            });\n          });\n          return;\n        }\n        if (error.code === HotCodePush.error.APPLICATION_BUILD_VERSION_TOO_LOW) {\n          this.updateApp();\n          return;\n        }\n        console.log(error);\n      });\n    });\n  }\n\n  updateApp() {\n    if (!this.config.get().hotUpdateUrl) {\n      return;\n    }\n    this.dialog.confirm('更新通知', '发现新版本,是否现在更新?', () => {\n      if (this.platform.is('ios')) {\n        this.updateIos();\n        return;\n      }\n      this.updateAndroid();\n    });\n  }\n\n  updateIos() {\n    window.location.href = this.config.get().hotUpdateUrl.ios;\n  }\n\n  updateAndroid() {\n    var targetPath = this.file.externalApplicationStorageDirectory + '/app/app.apk';\n    this.localNotifications.schedule({\n      id: 1000,\n      title: '正在更新...',\n      progress: true,\n      maxProgress: 100,\n      currentProgress: 0\n    });\n    let transfer = this.transfer.create();\n    transfer.onProgress(event => {\n      let progress = ((event.loaded / event.total) * 100).toFixed(2);\n      this.localNotifications.update({\n        id: 1000,\n        title: '正在更新...',\n        progress: true,\n        maxProgress: 100,\n        currentProgress: Math.round(Number(progress))\n      });\n    });\n    transfer.download(this.config.get().hotUpdateUrl.android, targetPath).then(() => {\n      this.localNotifications.clear(1000);\n      this.dialog.confirm('更新通知', '新版本下载完成是否现在安装?', () => {\n        this.fileOpener.open(targetPath, 'application/vnd.android.package-archive');\n      });\n    }, e => {\n      console.log(e);\n    });\n  }\nstatic decorators: DecoratorInvocation[] = [\n{ type: Injectable },\n];\n/** @nocollapse */\nstatic ctorParameters: () => ({type: any, decorators?: DecoratorInvocation[]}|null)[] = () => [\n{type: Platform, },\n{type: Dialog, },\n{type: ConfigProvider, },\n{type: HotCodePush, },\n{type: ExtLocalNotifications, },\n{type: Transfer, },\n{type: File, },\n{type: FileOpener, },\n];\n}\ninterface DecoratorInvocation {\n  type: Function;\n  args?: any[];\n}\n"]}